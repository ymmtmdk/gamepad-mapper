# ロガーライブラリ改善の調査・修正方針

## 現状分析

### 現在のロガーアーキテクチャ
- **ファイル構成**: `ILogger.h` (インターフェース) + `Logger.h/cpp` (実装)
- **総コード量**: 180行 (ヘッダー49行 + 実装131行)
- **使用箇所**: 57個のロガー呼び出し (6つのソースファイル)
- **出力ファイル**: `multi_gamepad_mapper.log` (実行ファイルと同じディレクトリ)
- **文字コード**: UTF-16 (wofstream使用)

### 現在の問題点
1. **パフォーマンス**: 同期的なファイル書き込み、毎回flush実行
2. **機能不足**: ログレベル管理、ローテーション機能なし
3. **保守性**: 手動でのフォーマット処理、エラーハンドリング不十分
4. **デバッグ**: ログ出力時のクラッシュ問題 (`std::filesystem::path` での文字列変換)
5. **実際の問題**: "Configuration loaded for device: Wireless Gamepad (file: " でログが途切れる
6. **設定ファイル読み込み**: 編集した設定が反映されない（デバッグ情報不足）
7. **文字コード**: UTF-16とUTF-8の混在による表示問題

### 使用パターン分析
- **LOG_WRITE/LOG_WRITE_W**: 永続ログ (28回使用)
- **FRAME_LOG_APPEND**: リアルタイム表示用 (15回使用)  
- **Logger::GetInstance()直接呼び出し**: 状態管理 (14回使用)

## 推奨ライブラリ: spdlog

### 選定理由
1. **高性能**: 非同期ロギング、最適化されたフォーマッタ
2. **豊富な機能**: ログレベル、複数シンク、ローテーション
3. **Windows対応**: UTF-16サポート、安定した動作
4. **軽量**: ヘッダーオンリー or コンパイル済み選択可能
5. **vcpkg対応**: 容易な統合

### アーキテクチャ設計

#### 1. 既存インターフェース保持
```
ILogger (既存インターフェース)
├── Logger (既存実装) - 段階的に削除
└── ModernLogger (新spdlog実装)
```

#### 2. ログ出力構成
- **メインログ**: `gamepad_mapper.log` (ローテーション: 5MB × 3ファイル)
- **フレームログ**: インメモリ + 必要時ファイル出力
- **コンソール**: デバッグ時のみ

#### 3. ログレベル
- `ERROR`: エラー、初期化失敗
- `WARN`: 警告、デバイス切断 
- `INFO`: 状態変化、デバイス検出
- `DEBUG`: 詳細トレース、ボタン押下

## 移行計画

### Phase 1: 基盤準備
1. vcpkg依存関係追加 (`spdlog`, `fmt`)
2. CMakeLists.txt更新
3. ModernLogger.h/cpp作成

### Phase 2: 段階的移行
1. 新しいマクロ定義 (LOG_INFO, LOG_DEBUG等)
2. Application.cpp から移行開始
3. 各モジュール順次移行

### Phase 3: 最適化
1. 非同期ロギング有効化
2. パフォーマンスチューニング
3. 旧ロガー削除

## 実装方針

### ファイル命名規則
- **避ける**: `SpdlogLogger` (ライブラリ名を含む)
- **推奨**: `ModernLogger` (機能を表現)

### 後方互換性
既存のマクロは段階的に置換:
```cpp
// 現在
#define LOG_WRITE_W(...) Logger::GetInstance().WriteW(__VA_ARGS__)

// 移行中 (両方サポート)  
#define LOG_WRITE_W(...) ModernLogger::GetInstance().WriteW(__VA_ARGS__)
#define LOG_INFO(...) ModernLogger::GetInstance().Info(__VA_ARGS__)

// 最終形
#define LOG_INFO(...) ModernLogger::GetInstance().Info(__VA_ARGS__)
```

### 設定管理
- 設定ファイル: `logger_config.json`
- ランタイム設定変更対応
- デフォルト設定の自動生成

## 期待される改善効果

1. **パフォーマンス**: 非同期ロギングで20-50%高速化
2. **保守性**: 標準化されたAPI、型安全性向上  
3. **デバッグ効率**: 構造化ログ、フィルタリング機能
4. **運用性**: ログローテーション、サイズ管理自動化
5. **拡張性**: 将来的なログ分析、監視システム連携
6. **問題解決**: 文字列変換でのクラッシュ問題解消
7. **トレーサビリティ**: 設定ファイル読み込み問題の詳細追跡可能

## リスク評価

### 低リスク
- spdlogは成熟したライブラリ (GitHub 20k+ stars)
- vcpkgで安定提供
- 段階的移行によるリスク最小化

### 対策
- 既存インターフェース保持による互換性確保
- テスト環境での事前検証
- ロールバック計画の準備

---
*調査日: 2024年*
*調査者: Rovo Dev*